<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#075E54"/>
<title>Need Analyzer</title>
<style>
  :root{
    --wa:#075E54;--wa2:#128C7E;--bg:#e5ddd5;--card:#fff;--btn1:#25D366;--btn2:#128C7E;
    --muted:#667781; --shadow:0 10px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);}
  .header{position:fixed;top:0;left:0;right:0;z-index:9;background:var(--wa);color:#fff;padding:18px 18px;font-weight:900;font-size:22px;letter-spacing:.2px;}
  .wrap{padding-top:78px;max-width:820px;margin:0 auto;min-height:100vh;}
  .bubble{margin:14px 14px 10px;padding:14px 16px;background:var(--card);border-radius:18px;font-size:16px;line-height:1.35;box-shadow:var(--shadow);}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 14px 18px;}
  .btn{border:none;cursor:pointer;padding:14px 18px;border-radius:999px;font-weight:900;font-size:16px;color:#fff;background:linear-gradient(90deg,var(--btn1),var(--btn2));box-shadow:0 10px 18px rgba(18,140,126,.20);}
  .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
  .card{margin:14px;padding:14px 16px;background:#fff;border-radius:18px;box-shadow:var(--shadow);}
  select{width:100%;padding:12px 12px;border-radius:14px;border:1px solid #d1d7db;background:#fff;font:inherit}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .chip{padding:10px 14px;border-radius:999px;border:1px solid #d1d7db;background:#fff;font-weight:800;cursor:pointer}
  .chip.sel{background:#dcf8c6;border-color:#cdeabc}
  .muted{color:var(--muted);font-size:13.5px;line-height:1.35}
  .title{font-weight:900;font-size:18px;margin:0 0 6px}

  /* ===== Export (PNG) look & feel (matches the attached reference) ===== */
  .exportTheme{
    position:relative;
    background:#000;
    border-radius:28px;
    padding:26px;
    overflow:hidden;
    box-shadow:0 18px 40px rgba(0,0,0,.45);
  }
  /* subtle sparkles / glow */
  .exportTheme:before{
    content:"";
    position:absolute; inset:-40px;
    background:
      radial-gradient(12px 12px at 14% 18%, rgba(255,255,255,.40), rgba(255,255,255,0) 60%),
      radial-gradient(10px 10px at 86% 22%, rgba(255,255,255,.28), rgba(255,255,255,0) 60%),
      radial-gradient(14px 14px at 78% 74%, rgba(255,255,255,.22), rgba(255,255,255,0) 60%),
      radial-gradient(10px 10px at 20% 78%, rgba(255,255,255,.20), rgba(255,255,255,0) 60%),
      radial-gradient(260px 180px at 15% 25%, rgba(39,174,96,.35), rgba(0,0,0,0) 60%),
      radial-gradient(280px 200px at 85% 18%, rgba(242,153,74,.35), rgba(0,0,0,0) 60%),
      radial-gradient(320px 240px at 50% 92%, rgba(47,128,237,.22), rgba(0,0,0,0) 60%);
    filter:blur(.2px);
    pointer-events:none;
  }
  .exportTheme:after{
    content:"";
    position:absolute; left:12%; right:12%; top:18px; height:14px;
    background:linear-gradient(90deg, rgba(39,174,96,.0), rgba(39,174,96,.28), rgba(242,153,74,.28), rgba(39,174,96,.0));
    filter:blur(10px);
    pointer-events:none;
  }
  .exportHeader{
    position:relative;
    margin:0 0 18px;
    padding:16px 22px;
    border-radius:999px;
    color:#fff;
    text-align:center;
    font-weight:950;
    font-size:30px;
    letter-spacing:.2px;
    background:linear-gradient(90deg, #27AE60, #2F80ED, #F2994A);
    box-shadow:0 0 0 2px rgba(255,255,255,.08), 0 12px 26px rgba(0,0,0,.35);
  }
  /* In export, bubbles are not chat bubbles; keep only the header pill */
  .exportTheme .bubble{background:transparent; box-shadow:none; padding:0; margin:0; border-radius:0;}
  .exportTheme .recWrap{margin:0;}
  .exportTheme .recCard{border-radius:22px; box-shadow:0 14px 28px rgba(0,0,0,.18);}
  .exportTheme .recTitle{font-size:28px; line-height:1.05;}
  .exportTheme .recProduct{font-size:22px;}
  .exportTheme .recDesc{font-size:18px;}
  .exportTheme .recSaved{font-size:16px;}

  /* Recommendation look & feel (as per screenshots) */
  .recWrap{margin:14px;}
  .recCard{
    position:relative;
    background:#fff;
    border-radius:18px;
    padding:18px 18px 16px 28px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }
  .recCard + .recCard{margin-top:14px;}
  .recBracket{
    position:absolute; left:10px; top:10px; bottom:10px; width:16px;
    border:4px solid var(--accent);
    border-right:none;
    border-radius:18px 0 0 18px;
    opacity:.95;
  }
  .recTitle{
    font-size:24px;
    font-weight:650;
    letter-spacing:.1px;
    margin:0 0 10px;
    color:#101518;
  }
  .recTitle .strong{font-weight:900;}
  .recProduct{
    margin:0 0 10px;
    font-size:20px;
    color:#101518;
  }
  .recProduct .label{font-weight:900;}
  .recDesc{
    margin:0 0 14px;
    font-size:18px;
    color:var(--muted);
  }
  .recSaved{
    display:flex;
    align-items:center;
    gap:10px;
    color:#9aa5ad;
    font-size:16px;
    font-style:italic;
    user-select:none;
  }
  .saveIcon{
    width:18px;height:18px; display:inline-block;
  }
  .saveIcon svg{width:18px;height:18px; display:block}
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script id="android-bridge-helper">
  // -------- Android WebView bridge helpers (safe in browser) --------
  function __hasAndroid(){ try{ return !!(window.Android); }catch(e){ return false; } }
  function __blobToBase64(blob){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onloadend = ()=> {
        const res = r.result || "";
        // res = "data:image/png;base64,...."
        const comma = res.indexOf(",");
        resolve(comma>=0 ? res.slice(comma+1) : res);
      };
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }
</script>

</head>
<body>
  <div class="header">Need Analyzer</div>
  <div class="wrap" id="app"></div>

<script>
(function(){
  const app = document.getElementById('app');

  const OPTIONS = {
    outflow: ["< 40k","40k – 1 lakh","1 – 1.5 lakhs","1.5 lakhs +","Prefer not to say"],
    wealth: ["< 10L","10L – 50L","50L – 1Cr","1Cr – 3Cr","3Cr+","Prefer not to say"],
    personality: ["Live for today","Live long"],
    colors: ["Black","Red","White","Blue"]
  };

  const goals = [
    ["child_edu","Child education"],
    ["child_wedding","Child wedding"],
    ["home_upgrade","Home upgrade"],
    ["retirement","Retirement lifestyle"],
    ["medical_parent","Medical/parent care"],
    ["business","Business / entrepreneurship"]
  ];

  const a = { outflow:null, wealth:null, personality:null, color:null, goals:{} };
  let gi = 0;
  let started = false;

  async function renderExportCanvas(){
    const source = document.getElementById('resultArea');
    if(!source) throw new Error('No result area');
    const clone = source.cloneNode(true);

    // Export header: convert the first bubble into the gradient pill header
    const firstBubble = clone.querySelector('.bubble');
    if(firstBubble){
      firstBubble.classList.add('exportHeader');
      firstBubble.innerHTML = 'Top-3 Recommendations';
    }

    // Ensure action buttons are never in export (safety)
    clone.querySelectorAll('.actionsRow, button').forEach(el=>{
      if(el && el.textContent && (el.textContent.trim()==='Download' || el.textContent.trim()==='Share')) el.remove();
    });

    // Create an offscreen wrapper with padding so image looks like a clean poster (not a cut/crop)
    const wrap = document.createElement('div');
    wrap.style.position = 'fixed';
    wrap.style.left = '-9999px';
    wrap.style.top = '0';
    wrap.className = 'exportTheme';
    wrap.style.display = 'inline-block';

    // lock width to on-screen width for consistent look
    wrap.style.width = source.getBoundingClientRect().width + 'px';

    // Add a little extra breathing room inside
    clone.style.margin = '0';
    wrap.appendChild(clone);
    document.body.appendChild(wrap);

    const canvas = await html2canvas(wrap, {scale: 2.5, backgroundColor: '#000', useCORS: true});
    wrap.remove();
    return canvas;
  }



  function bubble(html, opts){
    const b = document.createElement('div');
    b.className = 'bubble';
    b.innerHTML = html;
    app.appendChild(b);
    const o = opts||{};
    if(started && o.scroll !== false){
      if(started){ window.scrollTo(0, document.body.scrollHeight); }
    }
    return b;
  }

  function selectQ(q, options, onDone){
    bubble(q);
    const c = document.createElement('div');
    c.className = 'card';
    const s = document.createElement('select');
    s.innerHTML = '<option value="">Select…</option>' + options.map(x=>'<option>'+x+'</option>').join('');
    c.appendChild(s);
    const r = document.createElement('div'); r.className='row';
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Continue'; btn.disabled=true;
    r.appendChild(btn);
    c.appendChild(r);
    app.appendChild(c);
    s.onchange = ()=> btn.disabled = !s.value;
    btn.onclick = ()=> onDone(s.value);
    if(started){ window.scrollTo(0, document.body.scrollHeight); }
  }

  function yesNoQ(label, onDone){
    bubble(label);
    const c = document.createElement('div');
    c.className = 'card';
    const chips = document.createElement('div'); chips.className='chips';
    const y = document.createElement('div'); y.className='chip'; y.textContent='Yes';
    const n = document.createElement('div'); n.className='chip'; n.textContent='No';
    chips.appendChild(y); chips.appendChild(n);
    c.appendChild(chips);
    app.appendChild(c);

    function pick(v){
      y.classList.toggle('sel', v==='Yes');
      n.classList.toggle('sel', v==='No');
      onDone(v);
    }
    y.onclick=()=>pick('Yes');
    n.onclick=()=>pick('No');
    if(started){ window.scrollTo(0, document.body.scrollHeight); }
  }

  function saveIconSVG(){
    return `
      <span class="saveIcon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M5 3h12l2 2v16H5V3Z" stroke="#9aa5ad" stroke-width="2" stroke-linejoin="round"/>
          <path d="M7 3v6h10V3" stroke="#9aa5ad" stroke-width="2" stroke-linejoin="round"/>
          <path d="M8 21v-7h8v7" stroke="#9aa5ad" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </span>
    `;
  }

  function formatTitle(name){
    // Keep content as per logic; just emphasize first 2 words if possible for similar look & feel.
    const parts = (name||'').split(' ');
    if(parts.length <= 2) return `<span class="strong">${name}</span>`;
    const first = parts.slice(0,2).join(' ');
    const rest  = parts.slice(2).join(' ');
    return `<span class="strong">${first}</span> ${rest}`;
  }

  function score(){
    let protection=0, wealthBuild=0, goalBased=0;

    const outflowScore = {"< 40k":1,"40k – 1 lakh":2,"1 – 1.5 lakhs":3,"1.5 lakhs +":4,"Prefer not to say":2}[a.outflow]||2;
    const wealthTier   = {"< 10L":1,"10L – 50L":2,"50L – 1Cr":3,"1Cr – 3Cr":4,"3Cr+":5,"Prefer not to say":3}[a.wealth]||3;

    protection += outflowScore*2;
    wealthBuild += Math.max(0, wealthTier-1);
    goalBased  += Math.max(0, wealthTier-2);

    if(a.personality==="Live for today"){ protection += 1; wealthBuild += 1; }
    else { goalBased += 2; wealthBuild += 1; }

    const yesCount = Object.values(a.goals).filter(v=>v==="Yes").length;
    goalBased += yesCount*2;

    if(a.color==="Red") wealthBuild += 1;
    if(a.color==="Black") protection += 1;
    if(a.color==="Blue") goalBased += 1;

    const buckets = [
      {name:"Complete lifestyle support", product:"Digit Glow Plus", note:"Complete coverage of mortality + morbidity.", s:protection},
      {name:"Long term corpus building", product:"ULIP", note:"Long-term corpus building with riders.", s:wealthBuild},
      {name:"Pure goal based in long term", product:"Digit ICON", note:"Goal-aligned long-term approach.", s:goalBased}
    ].sort((x,y)=>y.s-x.s);

    const resultArea = document.createElement("div");
    resultArea.id = "resultArea";
    app.appendChild(resultArea);

    const topB = document.createElement("div");
    topB.className = "bubble";
    topB.innerHTML = "<b>Top-3 Recommendation</b>";
    resultArea.appendChild(topB);

    const wrap = document.createElement('div');
    wrap.className = 'recWrap';
    resultArea.appendChild(wrap);

    const accents = ["#2F80ED","#F2994A","#27AE60"]; // blue, orange, green
    buckets.forEach((b,i)=>{
      const rec = document.createElement('div');
      rec.className = 'recCard';
      rec.style.setProperty('--accent', accents[i] || "#2F80ED");
      rec.innerHTML = `
        <div class="recBracket"></div>
        <div class="recTitle">${formatTitle(b.name)}</div>
        <div class="recProduct"><span class="label">Product:</span> ${b.product}</div>
        <div class="recDesc">${b.note}</div>
        <div class="recSaved">${saveIconSVG()} <span>Details saved to history</span></div>
      `;
      wrap.appendChild(rec);
    });

    // Action buttons (same look as primary)
    const actions = document.createElement('div');
    actions.className = 'row actionsRow';
    actions.style.marginTop = '8px';

    const dlBtn = document.createElement('button');
    dlBtn.className = 'btn';
    dlBtn.textContent = 'Download';
    dlBtn.onclick = async ()=>{
      try{
        const canvas = await renderExportCanvas();
        const fileName = 'need-analyzer-output.png';
        const blob = await new Promise(res=>canvas.toBlob(res, 'image/png', 1.0));

        // Android WebView: save via native bridge
        try{
          if(__hasAndroid() && typeof window.Android.savePngBase64 === 'function'){
            const b64 = await __blobToBase64(blob);
            window.Android.savePngBase64(fileName, b64);
            return;
          }
        }catch(e){}

        // Browser fallback
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.download = fileName;
        a.href = url;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }catch(e){
        alert('Download not supported on this browser.');
      }
    };

    const shBtn = document.createElement('button');
    shBtn.className = 'btn';
    shBtn.textContent = 'Share';
    shBtn.onclick = async ()=>{
      const el = document.getElementById('resultArea');
      if(!el) return;

      // Prefer native share sheet (includes WhatsApp on most Android devices)
      try{
        const canvas = await renderExportCanvas();
        const blob = await new Promise(res=>canvas.toBlob(res, 'image/png'));
        const fileName = 'need-analyzer-output.png';
        const file = new File([blob], fileName, {type:'image/png'});

        // Android WebView: share via native bridge
        try{
          if(__hasAndroid() && typeof window.Android.sharePngBase64 === 'function'){
            const b64 = await __blobToBase64(blob);
            window.Android.sharePngBase64(fileName, b64);
            return;
          }
        }catch(e){}

        if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({
            title: 'Need Analyzer Output',
            text: 'Sharing my Need Analyzer output:',
            files: [file]
          });
          return;
        }
      }catch(e){ /* fallback below */ }

      // Fallback: share links (text only)
      const text = encodeURIComponent('Need Analyzer Output');
      const url = encodeURIComponent(location.href);
      const modal = document.createElement('div');
      modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,.5)'; modal.style.zIndex='9999';
      modal.innerHTML = `
        <div style="max-width:520px;margin:80px auto;background:#fff;border-radius:18px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.18)">
          <div style="font-weight:900;font-size:18px;margin-bottom:10px">Share</div>
          <div class="muted" style="margin-bottom:12px">Your browser doesn’t support sharing an image file. Use a quick link below (text only), or take a screenshot and share.</div>
          <div class="row" style="justify-content:flex-start">
            <a class="btn" style="text-decoration:none;display:inline-block" href="https://wa.me/?text=${text}%0A${url}" target="_blank" rel="noopener">WhatsApp</a>
            <a class="btn" style="text-decoration:none;display:inline-block" href="https://t.me/share/url?url=${url}&text=${text}" target="_blank" rel="noopener">Telegram</a>
            <a class="btn" style="text-decoration:none;display:inline-block" href="mailto:?subject=${text}&body=${text}%0A${url}">Email</a>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:6px">
            <button class="btn" id="closeShare">Close</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      modal.querySelector('#closeShare').onclick = ()=> modal.remove();
      modal.onclick = (ev)=>{ if(ev.target===modal) modal.remove(); };
    };

    actions.appendChild(dlBtn);
    actions.appendChild(shBtn);
    app.appendChild(actions);

    if(started){ window.scrollTo(0, document.body.scrollHeight); }
  }

  bubble("<b>Let’s Analyze Your Need!!</b><br><span class='muted'>Answer using ranges — no exact numbers needed.</span>");
  const start = document.createElement('div');
  start.className='row';
  start.innerHTML = '<button class="btn" id="go">Yes Let’s Begin!!</button>';
  app.appendChild(start);

  document.getElementById('go').onclick = ()=>{
    started = true;
    window.scrollTo(0, 0);

    selectQ("1) Monthly outflow for a family like yours?", OPTIONS.outflow, v=>{
      a.outflow=v;
      selectQ("2) Roughly, how much wealth does a family like yours have?", OPTIONS.wealth, v2=>{
        a.wealth=v2;
        selectQ("3) Which feels more like you?", OPTIONS.personality, v3=>{
          a.personality=v3;
          bubble("4) Any planned major expense in the next ~20 years? (Yes/No)");
          const askGoal = ()=>{
            const g = goals[gi];
            yesNoQ("Goal: "+g[1]+" — Planned?", yn=>{
              a.goals[g[0]] = yn;
              gi++;
              if(gi<goals.length) askGoal();
              else selectQ("5) Which car colour do you like most?", OPTIONS.colors, v5=>{
                a.color=v5;
                score();
              });
            });
          };
          askGoal();
        });
      });
    });
  };
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profile Intelligence</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --panel2:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --accent2:#06b6d4; --line:#1f2937;
      --btn:#0b1220;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text);}
    .header{position:sticky;top:0;z-index:10;background:#075E54;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,.25);}
    .header h1{margin:0;font-size:18px;color:#fff;}
    .theme-toggle{border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.15);color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;}
    .wrap{max-width:820px;margin:0 auto;padding:18px;}
    .bubble{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.18);}
    .bubble h2{margin:0 0 8px;font-size:18px;}
    .bubble p{margin:8px 0;color:var(--muted);line-height:1.45}
    .btnRow{display:flex;justify-content:center;margin:16px 0;}
    .btn{border:none;border-radius:14px;padding:14px 18px;font-weight:800;cursor:pointer;color:#03150d;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      box-shadow:0 10px 24px rgba(34,197,94,.18);
    }
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--line);box-shadow:none;}
    .smallNote{color:var(--muted);font-size:13px;text-align:center;margin-top:10px}
    .centerOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50;background:rgba(0,0,0,.35);backdrop-filter: blur(2px);}
    .centerCard{width:min(520px,90vw);text-align:center;}
    .toast{display:inline-block;background:rgba(15,23,42,.92);border:1px solid var(--line);color:var(--text);
      padding:10px 14px;border-radius:999px;margin-bottom:14px;font-weight:700;
    }
    .progressWrap{display:flex;align-items:center;justify-content:center;gap:12px;}
    .bar{width:min(520px,80vw);height:14px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);position:relative;overflow:hidden;}
    .bar > i{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a);}
    .barLabel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;color:#03150d;mix-blend-mode:screen;}
    .stage{display:none;margin-top:14px;}
    .field{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);outline:none;}
    .field::placeholder{color:rgba(148,163,184,.75);}
    .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px;}
    .result{margin-top:18px;}
    .accordion{display:flex;flex-direction:column;gap:10px;}
    .acc-item{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.03);}
    .acc-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;cursor:pointer;}
    .acc-title{font-weight:900;}
    .acc-plus{width:28px;height:28px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.18); font-weight:900;
    }
    .acc-body{max-height:0;overflow:hidden;transition:max-height .25s ease;padding:0 14px;}
    .acc-body p{margin:0;padding:10px 0 14px;color:#e5e7eb;line-height:1.45}
    .acc-item.open .acc-body{max-height:220px;}
    .acc-item.open .acc-plus{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#03150d;border:none;}
    .export-actions{display:none;justify-content:center;gap:10px;flex-wrap:wrap;margin:16px 0 6px;}
    .exporting .acc-body{display:none !important;}
    .exporting .acc-plus{display:none !important;}
    .exporting .export-actions{display:none !important;}
    .fadeIn{animation: fade .35s ease both;}
    @keyframes fade{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script id="android-bridge-helper">
    function __hasAndroid(){ try{ return !!(window.Android); }catch(e){ return false; } }
    function __blobToBase64(blob){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onloadend = ()=> {
          const res = r.result || "";
          const comma = res.indexOf(",");
          resolve(comma>=0 ? res.slice(comma+1) : res);
        };
        r.onerror = reject;
        r.readAsDataURL(blob);
      });
    }
  </script>
</head>
<body>
  <div class="header">
    <h1>Profile Intelligence</h1>
    <button id="themeToggle" class="theme-toggle" type="button">Dark</button>
  </div>

  <div class="wrap">
    <div id="intro" class="bubble">
      <h2>Let’s visit the client’s LinkedIn profile.</h2>
      <p>Scroll the profile a bit. Once enough content is captured, you’ll see <b>Get Insights</b>.</p>
      <div class="btnRow">
        <button class="btn" id="btnGo">Let’s Go!!</button>
      </div>
      <p class="smallNote">In app: opens inside WebView. In browser: opens LinkedIn site.</p>
    </div>

    <div id="stageAdditional" class="stage bubble">
      <h2>Additional Information</h2>
      <p>Optional — helps make insights sharper.</p>
      <textarea id="additionalInfo" class="field" rows="4" placeholder="Input additional information if any"></textarea>
      <div class="actions">
        <button class="btn" id="btnGetInsights2">Get Insights</button>
        <button class="btn secondary" id="btnBackToLinkedIn">Back to Profile</button>
      </div>
    </div>

    <div id="stageResults" class="stage">
      <div class="export-actions" id="exportActions">
        <button class="btn" id="btnDownload">Download</button>
        <button class="btn secondary" id="btnShare">Share</button>
      </div>
      <div class="result bubble">
        <h2 style="margin:0 0 10px;">Profile Insights</h2>
        <div id="acc" class="accordion"></div>
      </div>
    </div>
  </div>

  <!-- Center overlay while capturing -->
  <div id="overlay" class="centerOverlay">
    <div class="centerCard">
      <div id="scrollToast" class="toast">Kindly scroll through the profile<span id="dots">.</span></div>
      <div class="progressWrap">
        <div class="bar">
          <i id="barFill"></i>
          <div class="barLabel" id="barLabel">0%</div>
        </div>
      </div>
      <div style="margin-top:16px;">
        <button class="btn" id="btnGetInsights1" style="display:none;">Get Insights</button>
      </div>
    </div>
  </div>

<script>
  // ---- Theme toggle ----
  (function(){
    const btn = document.getElementById('themeToggle');
    const saved = localStorage.getItem('pi_theme');
    if(saved === 'light'){
      document.documentElement.style.setProperty('--bg','#ffffff');
      document.body.style.background = '#ffffff';
      document.body.style.color = '#0b1020';
    }
    btn.onclick = ()=>{
      const isDark = document.body.style.background !== 'rgb(255, 255, 255)';
      if(isDark){
        document.documentElement.style.setProperty('--bg','#ffffff');
        document.body.style.background = '#ffffff';
        document.body.style.color = '#0b1020';
        localStorage.setItem('pi_theme','light');
      }else{
        document.documentElement.style.setProperty('--bg','#0b1020');
        document.body.style.background = '#0b1020';
        document.body.style.color = '#e5e7eb';
        localStorage.setItem('pi_theme','dark');
      }
    };
  })();

  const WORKER_URL = "https://dry-fire-c28e.davidtudu1999.workers.dev/";

  const MIN_CHARS = 3000;
  const overlay = document.getElementById('overlay');
  const dotsEl = document.getElementById('dots');
  const barFill = document.getElementById('barFill');
  const barLabel = document.getElementById('barLabel');
  const btnGet1 = document.getElementById('btnGetInsights1');
  const btnGo = document.getElementById('btnGo');
  const stageAdditional = document.getElementById('stageAdditional');
  const stageResults = document.getElementById('stageResults');
  const acc = document.getElementById('acc');
  const exportActions = document.getElementById('exportActions');

  function openLinkedIn(){
    try{
      if(__hasAndroid() && typeof window.Android.openLinkedIn === "function"){
        window.Android.openLinkedIn();
        return;
      }
    }catch(e){}
    window.location.href = "https://www.linkedin.com/";
  }
  btnGo.onclick = openLinkedIn;

  // ---- "keep scrolling..." dots animation ----
  let dotsN = 1;
  setInterval(()=>{
    dotsN = dotsN % 3 + 1;
    dotsEl.textContent = ".".repeat(dotsN);
  }, 500);

  function showOverlay(){ overlay.style.display = 'flex'; }
  function hideOverlay(){ overlay.style.display = 'none'; }

  function getCapturedText(){
    // App should write captured text here
    try{
      return (localStorage.getItem('pi_captured') || '').trim();
    }catch(e){ return ''; }
  }

  function updateProgress(){
    const t = getCapturedText();
    const pct = Math.max(0, Math.min(100, Math.round((t.length / MIN_CHARS) * 100)));
    barFill.style.width = pct + "%";
    barLabel.textContent = pct + "%";
    if(t.length >= MIN_CHARS){
      document.getElementById('scrollToast').style.display = 'none';
      btnGet1.style.display = 'inline-block';
    }else{
      document.getElementById('scrollToast').style.display = 'inline-block';
      btnGet1.style.display = 'none';
    }
  }

  // Show overlay whenever we have started LinkedIn capture but not yet enough
  let overlayTimer = setInterval(()=>{
    const t = getCapturedText();
    if(t.length > 0 && t.length < MIN_CHARS){
      showOverlay();
      updateProgress();
    }else if(t.length >= MIN_CHARS){
      showOverlay();
      updateProgress();
    }
  }, 700);

  // First "Get Insights" (center) -> additional info stage
  btnGet1.onclick = ()=>{
    hideOverlay();
    stageAdditional.style.display = 'block';
    stageAdditional.classList.add('fadeIn');
    // Keep results hidden until second click
    stageResults.style.display = 'none';
    try{ window.scrollTo({top:0, behavior:'smooth'}); }catch(e){}
  };

  // Back to profile (app should open last LinkedIn URL or just reopen)
  document.getElementById('btnBackToLinkedIn').onclick = openLinkedIn;

  // Second "Get Insights" -> call worker and render accordions
  document.getElementById('btnGetInsights2').onclick = async ()=>{
    const profileText = getCapturedText();
    if(profileText.length < MIN_CHARS){
      showOverlay();
      updateProgress();
      return;
    }
    const additionalInfo = (document.getElementById('additionalInfo').value || '').trim();
    const profileUrl = (localStorage.getItem('pi_url') || '').trim();

    // Reset UI
    acc.innerHTML = '';
    stageResults.style.display = 'block';
    stageResults.classList.add('fadeIn');
    exportActions.style.display = 'none';

    let payload = { profileText, additionalInfo, profileUrl };

    try{
      const r = await fetch(WORKER_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if(!r.ok || !data.points){
        alert((data && data.error) ? data.error : 'Could not generate insights.');
        return;
      }

      // Render 7 points one-by-one (pop up)
      const pts = data.points || [];
      for(let i=0;i<pts.length;i++){
        const item = makeAccItem(i+1, pts[i].title, pts[i].body);
        acc.appendChild(item);
        item.classList.add('fadeIn');
        await new Promise(res=>setTimeout(res, 180));
      }
      exportActions.style.display = 'flex';
      try{ window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});}catch(e){}
    }catch(e){
      alert('Network error while generating insights.');
    }
  };

  function closeAllExcept(el){
    document.querySelectorAll('.acc-item.open').forEach(x=>{
      if(x !== el) x.classList.remove('open');
    });
  }

  function makeAccItem(n, title, body){
    const wrap = document.createElement('div');
    wrap.className = 'acc-item';
    const head = document.createElement('div');
    head.className = 'acc-head';
    const t = document.createElement('div');
    t.className = 'acc-title';
    t.textContent = `${n}. ${String(title||'Point').slice(0,34)}`;
    const plus = document.createElement('div');
    plus.className = 'acc-plus';
    plus.textContent = '+';
    head.appendChild(t);
    head.appendChild(plus);

    const b = document.createElement('div');
    b.className = 'acc-body';
    const p = document.createElement('p');
    p.textContent = body || '';
    b.appendChild(p);

    head.onclick = ()=>{
      const isOpen = wrap.classList.contains('open');
      if(isOpen){
        wrap.classList.remove('open');
      }else{
        closeAllExcept(wrap);
        wrap.classList.add('open');
      }
    };

    wrap.appendChild(head);
    wrap.appendChild(b);
    return wrap;
  }

  async function captureSummaryPng(){
    if(!window.html2canvas){ alert('Export library not loaded.'); return null; }
    // export only the 7 bars (collapsed)
    document.body.classList.add('exporting');
    // force close all
    document.querySelectorAll('.acc-item.open').forEach(x=>x.classList.remove('open'));
    const target = document.querySelector('#stageResults .result');
    const canvas = await html2canvas(target, {backgroundColor:'#0b1020', scale:3, useCORS:true});
    document.body.classList.remove('exporting');
    const blob = await new Promise(res=>canvas.toBlob(res,'image/png',1.0));
    return blob;
  }

  function exportFileName(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    return `profile-insights-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}.png`;
  }

  document.getElementById('btnDownload').onclick = async ()=>{
    const blob = await captureSummaryPng();
    if(!blob) return;
    const name = exportFileName();

    // Android WebView
    try{
      if(__hasAndroid() && typeof window.Android.savePngBase64 === 'function'){
        const b64 = await __blobToBase64(blob);
        window.Android.savePngBase64(name, b64);
        return;
      }
    }catch(e){}

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  };

  document.getElementById('btnShare').onclick = async ()=>{
    const blob = await captureSummaryPng();
    if(!blob) return;
    const name = exportFileName();

    // Android WebView
    try{
      if(__hasAndroid() && typeof window.Android.sharePngBase64 === 'function'){
        const b64 = await __blobToBase64(blob);
        window.Android.sharePngBase64(name, b64);
        return;
      }
    }catch(e){}

    // Browser share
    try{
      if(navigator.share && navigator.canShare){
        const file = new File([blob], name, {type:'image/png'});
        if(navigator.canShare({files:[file]})){
          await navigator.share({files:[file], title:'Profile Insights'});
          return;
        }
      }
    }catch(e){}
    // fallback
    alert('Sharing not supported here. Please download instead.');
  };
</script>
</body>
</html>

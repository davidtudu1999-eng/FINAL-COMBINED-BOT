<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#075E54"/>
  <title>Profile Intelligence</title>
  <style>
    :root { 
      --text:#111;
--wa:#075E54; --wa2:#128C7E; --bg:#e5ddd5; --card:#ffffff; --btn1:#25D366; --btn2:#128C7E; }
    *{box-sizing:border-box}
    body{
      color: var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);}
    .header{
      background: linear-gradient(90deg,var(--wa),var(--wa2));
      color:#fff;
      padding:18px 18px;
      font-size:26px;
      font-weight:800;
      letter-spacing:.2px;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .wrap{padding-top:100px;max-width:820px;margin:0 auto;min-height:100vh;}
    .bubble{
      margin:18px;padding:18px 20px;background:var(--card);
      border-radius:18px;font-size:20px;line-height:1.4;
      box-shadow:0 6px 22px rgba(0,0,0,.08);
    }
    .bubble h2{margin:0 0 10px;font-size:22px}
    .sub{margin:0;color:#334}
    .hint{margin-top:10px;font-size:16px;color:#556}
    .btnRow{
      display:flex;gap:16px;flex-wrap:wrap;
      justify-content:center;padding:10px 18px 30px;
    }
    .btn{
      border:none;cursor:pointer;padding:18px 26px;border-radius:999px;
      font-weight:900;font-size:18px;color:#fff;
      background:linear-gradient(90deg,var(--btn1),var(--btn2));
      min-width:220px;
    }
    .smallNote{
      margin:0 18px 22px;
      font-size:14px;color:#566; text-align:center;
    }
    code{background:#f3f3f3;padding:2px 6px;border-radius:8px}
  

    html[data-theme="dark"]{
      --bg:#0b141a;
      --card:#1f2c33;
      --muted:#b9c2c7;
      --shadow: rgba(0,0,0,.35);
      --text:#e9edef;
    }
    .theme-toggle{
      border:1px solid rgba(255,255,255,.65);
      background: rgba(255,255,255,.12);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }
    .theme-toggle:active{ transform: scale(.98); }

/* Floating Home Button */
.floatingHome{
  position: fixed;
  right: 18px;
  bottom: calc(18px + env(safe-area-inset-bottom));
  z-index: 9999;
}
.floatingHome .btn{
  width: auto;
  min-width: 120px;
  padding: 14px 22px;
  border-radius: 999px;
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
}

</style>
</head>
<body>
  <div class="header"><span>Profile Intelligence</span><button id="themeToggle" class="theme-toggle" type="button">Dark</button></div>

  <div class="wrap">
    <div class="bubble" id="introCard">
      <h2>Let’s first visit the client’s LinkedIn profile.</h2>
      <p class="sub">Once you open the profile, you’ll get a <b>Get Insights</b> button to generate the 7 key discussion points.</p>
      <p class="hint">Tip: If LinkedIn asks to log in, please log in once — you won’t need to do it again in the app.</p>
    </div>

    <div class="btnRow">
      <button class="btn" onclick="openLinkedIn()">Let’s Go!!</button>
    </div>

    <p class="smallNote">
      If you’re not using the app version, this will open LinkedIn in your browser.
    </p>
  </div>
  <!-- ===== In-app capture + Insights UI ===== -->
  <div id="piReady" class="bubble" style="display:none; margin-top:18px;">
    <h2 style="margin-bottom:6px;">Profile captured ✅</h2>
    <p class="sub" id="piMeta" style="margin-top:0;">Tap below to generate the 7 insights.</p>
    <div class="btnRow" style="margin-top:14px;">
      <button id="genBtn" class="btn" type="button">Get Insights</button>
    </div>
    <p class="smallNote" style="margin-top:10px;">
      If this looks stuck, tap “Clear & Start Over”.
    </p>
    <div class="btnRow" style="margin-top:12px;">
      <button id="clearBtn" class="btn" type="button" style="background:#111827;">Clear & Start Over</button>
    </div>
  </div>

  <div id="piOutput" class="wrap" style="display:none; padding-top:14px;">
    <div class="bubble">
      <h2 style="margin-bottom:6px;">7 Profile Insights</h2>
      <p class="sub" style="margin-top:0;">Use these as discussion points.</p>
    </div>

    <div id="acc" style="margin-top:14px;"></div>

    <div class="btnRow" style="margin-top:18px;">
      <button id="shareBtn" class="btn" type="button">Share</button>
    </div>
  </div>


  <script>
  // ====== CONFIG (edit only if worker URL changes) ======
  const WORKER_URL = "https://dry-fire-c28e.davidtudu1999.workers.dev"; // no trailing slash needed

  // ====== LinkedIn open (App bridge first) ======
  function openLinkedIn(){
    try{
      if(window.Android && typeof window.Android.openLinkedIn === "function"){
        window.Android.openLinkedIn();
        return;
      }
    }catch(e){}
    window.location.href = "https://www.linkedin.com/";
  }

  // ====== Theme toggle (same behavior) ======
  (function(){
    const btn = document.getElementById('themeToggle');
    const root = document.documentElement;
    function setTheme(t){
      if(t === 'dark'){ root.dataset.theme = 'dark'; btn.textContent = 'Light'; }
      else { delete root.dataset.theme; btn.textContent = 'Dark'; }
      try{ localStorage.setItem('tara_theme', t); }catch(e){}
    }
    let saved = 'light';
    try{ saved = localStorage.getItem('tara_theme') || 'light'; }catch(e){}
    setTheme(saved);
    btn.addEventListener('click', function(){
      const current = root.dataset.theme === 'dark' ? 'dark' : 'light';
      setTheme(current === 'dark' ? 'light' : 'dark');
    });
  })();

  // ====== UI helpers ======
  const elIntro = document.getElementById('piIntro');
  const elAfter = document.getElementById('piAfter');
  const elLoading = document.getElementById('piLoading');
  const elManual = document.getElementById('piManual');
  const elTA = document.getElementById('piTextArea');
  const elGen = document.getElementById('piGenerateBtn');
  const elErr = document.getElementById('piErr');
  const elAcc = document.getElementById('piAccordions');

  function showError(msg){
    elErr.style.display = 'block';
    elErr.textContent = msg;
  }
  function clearError(){
    elErr.style.display = 'none';
    elErr.textContent = '';
  }

  function makeAccordionItem(i, title, body){
    const wrap = document.createElement('div');
    wrap.style.border = '1px solid rgba(0,0,0,.10)';
    wrap.style.borderRadius = '16px';
    wrap.style.overflow = 'hidden';
    wrap.style.marginBottom = '12px';
    wrap.style.background = 'rgba(255,255,255,0.85)';

    const header = document.createElement('button');
    header.type = 'button';
    header.style.width = '100%';
    header.style.textAlign = 'left';
    header.style.padding = '14px 14px';
    header.style.border = '0';
    header.style.background = 'transparent';
    header.style.display = 'flex';
    header.style.alignItems = 'center';
    header.style.justifyContent = 'space-between';
    header.style.fontFamily = 'inherit';
    header.style.fontWeight = '800';
    header.style.fontSize = '16px';
    header.style.cursor = 'pointer';

    const left = document.createElement('div');
    left.textContent = (i+1) + ") " + (title || ("Point " + (i+1)));

    const right = document.createElement('div');
    right.textContent = "+";
    right.style.fontSize = "20px";
    right.style.opacity = "0.7";

    header.appendChild(left);
    header.appendChild(right);

    const content = document.createElement('div');
    content.style.padding = '0 14px 14px';
    content.style.display = 'none';
    content.style.color = 'rgba(0,0,0,.78)';
    content.style.fontWeight = '500';
    content.style.lineHeight = '1.4';
    content.textContent = body || "";

    header.addEventListener('click', () => {
      const open = content.style.display === 'block';
      content.style.display = open ? 'none' : 'block';
      right.textContent = open ? '+' : '–';
    });

    wrap.appendChild(header);
    wrap.appendChild(content);
    return wrap;
  }

  async function callWorker(profileText){
    clearError();
    elLoading.textContent = "⏳ Please wait";
    elAcc.innerHTML = "";

    const payload = {
      profileText: profileText
    };

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if(!res.ok){
      throw new Error(data.error || ("HTTP " + res.status));
    }
    if(!data.points || !Array.isArray(data.points)){
      throw new Error("Invalid response from worker");
    }

    elLoading.textContent = "✅ Done";
    data.points.slice(0,7).forEach((p, idx) => {
      elAcc.appendChild(makeAccordionItem(idx, p.title, p.body));
    });
  }

  // ====== Entry points for App injection ======
  // Android can call: window.PI_setCapturedText("...") after it saves/reads the LinkedIn text.
  window.PI_setCapturedText = function(text){
    try {
      if(typeof text !== "string") text = String(text || "");
    } catch(e){ text = ""; }

    const t = text.trim();
    if(!t){
      showError("No captured text received from app.");
      return;
    }

    // Switch UI from intro to results
    if(elIntro) elIntro.style.display = "none";
    elAfter.style.display = "block";

    callWorker(t).catch(err => {
      showError("Worker error: " + (err && err.message ? err.message : String(err)));
    });
  };

  // Browser fallback: show manual mode if we are NOT inside app bridge
  (function initBrowserMode(){
    const inApp = !!(window.Android && (typeof window.Android.openLinkedIn === "function"));
    if(inApp) return;

    // show manual input inside results card (optional)
    elAfter.style.display = "block";
    elManual.style.display = "block";
    elLoading.style.display = "none";

    elGen.addEventListener('click', () => {
      const t = (elTA.value || "").trim();
      if(!t){ showError("Please paste some profile text first."); return; }
      elLoading.style.display = "block";
      callWorker(t).catch(err => {
        showError("Worker error: " + (err && err.message ? err.message : String(err)));
      });
    });
  })();

function goHome(){
  try{
    if(window.Android && typeof window.Android.goHome === "function"){
      window.Android.goHome();
      return;
    }
  }catch(e){}
  window.location.href = "index.html";
}



/* ===========================
   In-app capture integration
   =========================== */
const LS_CAPTURED = "pi_captured";
const LS_PROFILE_URL = "pi_profile_url";

function $(id){ return document.getElementById(id); }

function showIntro(){
  $("introCard").style.display = "";
  $("piReady").style.display = "none";
  $("piOutput").style.display = "none";
}

function showReady(){
  $("introCard").style.display = "none";
  $("piReady").style.display = "";
  $("piOutput").style.display = "none";
  const t = (localStorage.getItem(LS_CAPTURED) || "");
  const u = (localStorage.getItem(LS_PROFILE_URL) || "");
  $("piMeta").textContent = `Captured ${t.length} characters` + (u ? ` • URL saved` : "");
}

function showOutput(){
  $("introCard").style.display = "none";
  $("piReady").style.display = "none";
  $("piOutput").style.display = "";
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}

function renderAccordion(points){
  const acc = $("acc");
  acc.innerHTML = "";
  points.forEach((p, i) => {
    const item = document.createElement("details");
    item.className = "bubble";
    item.style.padding = "14px";
    item.style.marginTop = "12px";
    const sum = document.createElement("summary");
    sum.style.cursor = "pointer";
    sum.style.fontWeight = "900";
    sum.style.fontSize = "18px";
    sum.textContent = `${i+1}. ${p.title || ("Point " + (i+1))}`;
    const body = document.createElement("div");
    body.style.marginTop = "10px";
    body.style.color = "#0f172a";
    body.style.lineHeight = "1.45";
    body.innerHTML = escapeHtml(p.body || "");
    item.appendChild(sum);
    item.appendChild(body);
    acc.appendChild(item);
  });
}

async function generateInsights(){
  const captured = (localStorage.getItem(LS_CAPTURED) || "").trim();
  if(!captured){
    alert("No captured profile text found. Please go back and capture again.");
    showIntro();
    return;
  }
  $("genBtn").disabled = true;
  $("genBtn").textContent = "Generating...";
  try{
    const payload = {
      profileText: captured,
      profileUrl: (localStorage.getItem(LS_PROFILE_URL) || "").trim()
    };
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok){
      throw new Error(data && (data.error || data.message) ? (data.error || data.message) : ("HTTP " + res.status));
    }
    const points = data.points || [];
    if(!Array.isArray(points) || points.length !== 7){
      throw new Error("Worker did not return 7 points.");
    }
    renderAccordion(points);
    // Prepare share text
    window.__piShareText = (data.response || points.map((p, idx)=>`${idx+1}) ${p.title}\n${p.body}`).join("\n\n"));
    showOutput();
  }catch(e){
    alert("Error: " + (e && e.message ? e.message : String(e)));
    showReady();
  }finally{
    $("genBtn").disabled = false;
    $("genBtn").textContent = "Get Insights";
  }
}

/* Called by Android: inject captured text */
window.PI_setCapturedText = function(text){
  try{
    const t = (text || "").toString();
    localStorage.setItem(LS_CAPTURED, t);
    showReady();
  }catch(e){
    console.log("PI_setCapturedText error", e);
  }
};

/* Optional: store profile URL too */
window.PI_setProfileUrl = function(url){
  try{
    const u = (url || "").toString();
    if(u) localStorage.setItem(LS_PROFILE_URL, u);
  }catch(e){}
};

/* Optional: set worker URL dynamically */
window.PI_setWorkerUrl = function(url){
  try{
    const u = (url || "").toString().trim();
    if(u) localStorage.setItem("pi_worker_url", u);
  }catch(e){}
};

document.addEventListener("DOMContentLoaded", function(){
  // wire buttons
  $("genBtn").addEventListener("click", generateInsights);
  $("clearBtn").addEventListener("click", function(){
    try{
      localStorage.removeItem(LS_CAPTURED);
      localStorage.removeItem(LS_PROFILE_URL);
    }catch(e){}
    showIntro();
  });
  $("shareBtn").addEventListener("click", function(){
    const txt = window.__piShareText || "";
    if(window.Android && typeof window.Android.shareText === "function"){
      window.Android.shareText(txt);
    }else if(navigator.share){
      navigator.share({ text: txt });
    }else{
      alert(txt);
    }
  });

  // initial state
  const captured = (localStorage.getItem(LS_CAPTURED) || "").trim();
  if(captured && captured.length >= 200){
    showReady();
  }else{
    showIntro();
  }
});

</script>

<div class="floatingHome"><button class="btn" onclick="goHome()">Home</button></div>

</body>
</html>

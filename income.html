<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#075E54"/>
<title>Income Astrologer</title>
<style>
  :root{
    --wa:#075E54; --btn1:#25D366; --btn2:#128C7E;
    --bg:#e5ddd5; --card:#ffffff; --muted:#667781;
    --dark:#0b1020; --cyan:#22c7f4; --gold:#f6b21a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);}
  .header{position:fixed;top:0;left:0;right:0;z-index:9;background:var(--wa);color:#fff;padding:18px 18px;font-weight:900;font-size:22px;letter-spacing:.2px;}
  .wrap{padding-top:92px;max-width:820px;margin:0 auto;min-height:100vh;}
  .bubble{margin:14px 14px 10px;padding:14px 16px;background:var(--card);border-radius:18px;font-size:16px;line-height:1.35;}
  .card{margin:14px;padding:14px 16px;background:#fff;border-radius:18px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 14px 18px;}
  .btn{border:none;cursor:pointer;padding:14px 18px;border-radius:999px;font-weight:900;font-size:16px;color:#fff;background:linear-gradient(90deg,var(--btn1),var(--btn2));}
  input{width:100%;padding:12px 12px;border-radius:14px;border:1px solid #d1d7db;background:#fff;font:inherit}
  .muted{color:var(--muted);font-size:13.5px;line-height:1.35}
  .chartCard{background:var(--dark); color:#e6eef7; border-radius:20px; overflow:hidden; padding:14px; margin:14px;}
  .chartTitle{font-weight:900;text-align:center;font-size:20px;margin:6px 0 6px;}
  .chartSub{font-weight:900;text-align:center;font-size:16px;opacity:.92;margin:0 0 10px;}
  .legend{display:flex;justify-content:center;gap:18px;font-weight:800;opacity:.95;margin-bottom:8px;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
  .dot.cyan{background:var(--cyan)}
  .dot.gold{background:var(--gold)}
  .note{font-size:12.5px;opacity:.85;margin-top:8px;text-align:center}
  .table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13.5px}
  .table th,.table td{padding:10px 8px;border-top:1px solid rgba(255,255,255,.12);text-align:center}
  .table th{opacity:.9;font-weight:900}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.10);font-weight:900}

  .export-area{ display:flex; justify-content:center; align-items:center; padding:0; }
  @media print{ .actions{ display:none !important; } }
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script id="android-bridge-helper">
  // -------- Android WebView bridge helpers (safe in browser) --------
  function __hasAndroid(){ try{ return !!(window.Android); }catch(e){ return false; } }
  function __blobToBase64(blob){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onloadend = ()=> {
        const res = r.result || "";
        // res = "data:image/png;base64,...."
        const comma = res.indexOf(",");
        resolve(comma>=0 ? res.slice(comma+1) : res);
      };
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }
</script>

</head>
<body>
  <div class="header">Income Astrologer</div>
  <div class="wrap" id="app"></div>

<script>
(function(){
  const app = document.getElementById('app');

  function bubble(html){
    const b = document.createElement('div');
    b.className = 'bubble';
    b.innerHTML = html;
    app.appendChild(b);
    window.scrollTo(0, document.body.scrollHeight);
    return b;
  }

  function inputQ(q, placeholder, type, onDone){
    bubble(q);
    const c = document.createElement('div');
    c.className='card';
    const inp = document.createElement('input');
    inp.type = type || 'number';
    inp.placeholder = placeholder || '';
    if(type !== 'text') inp.inputMode = 'numeric';
    c.appendChild(inp);
    const r = document.createElement('div'); r.className='row';
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Continue'; btn.disabled=true;
    r.appendChild(btn);
    c.appendChild(r);
    app.appendChild(c);
    const valid = ()=>{
      const v = inp.value.trim();
      if(type === 'text'){
        btn.disabled = (v === '');
      } else {
        btn.disabled = (v === '' || isNaN(Number(v)));
      }
    };
    inp.addEventListener('input', valid);
    inp.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !btn.disabled){ btn.click(); }
    });
    btn.onclick = ()=>{
      const v = inp.value.trim();
      if(type === 'text') onDone(v);
      else onDone(Number(v));
    };
    inp.focus();
    window.scrollTo(0, document.body.scrollHeight);
  }

  // --- Model (matches your screenshots closely; can be tuned later) ---
  // Inputs:
  // leadsY1: number
  // meetingRate: percent (0-100)
  // Assumptions (from screenshots):
  // conversionRate = 30%
  // high performer = 1.5x
  // Base income per "sale" ≈ 0.19 LPA
  // Growth curve multipliers for 5 years (renewal stacking effect)
  const CONV = 0.30;
  const INCOME_PER_SALE_LPA = 0.19;
  const MULT = [1.00, 1.50, 2.25, 2.75, 3.50]; // Year1..Year5
  const HIGH_MULT = 1.50;
  // Fixed chart ceiling so different scenarios are comparable
  // Upper bound reference: ~400 leads & ~90% meeting rate gives ~₹111L high-performer by Year 5 in your sheet
  const Y_AXIS_MAX_LPA = 120;

  function roundLpa(x){
    // Excel-like feel: round to nearest whole L
    return Math.round(x);
  }

  function estimate(leadsY1, meetingRatePct){
    const mr = Math.max(0, Math.min(100, meetingRatePct)) / 100;
    const salesY1 = leadsY1 * mr * CONV;
    const base = salesY1 * INCOME_PER_SALE_LPA; // LPA
    const annual = MULT.map(m=>roundLpa(base*m));
    const high = annual.map(v=>roundLpa(v*HIGH_MULT));
    return {annual, high};
  }

  // --- Chart (SVG) ---
  function renderChart(annual, high, advisorName){
    const card = document.createElement('div');
    card.className = 'chartCard';
    card.innerHTML = `
      <div id="exportArea" class="exportArea">
      <div class="chartTitle">Income Astrologer</div>
      <div class="chartSub" id="chartSub"></div>
      <div class="legend">
        <span><span class="dot cyan"></span>Annual Income</span>
        <span><span class="dot gold"></span>High Performer</span>
      </div>
      <div id="svgWrap"></div>
    </div>
      <div id="actionRow" class="row" style="margin-top:14px;margin-bottom:4px;">
        <button class="btn" id="btnDownload">Download</button>
        <button class="btn" id="btnShare">Share</button>
      </div>
    `;
    app.appendChild(card);

    // Subtitle
    const sub = card.querySelector('#chartSub');
    if(sub){
      const safeName = (advisorName||'').trim();
      sub.textContent = safeName ? `${safeName} Ji's Income Potential` : ``;
    }

    const W = 760, H = 320;
    const padL=40, padR=24, padT=20, padB=52;

    const all = annual.concat(high);
    const maxV = Y_AXIS_MAX_LPA;
    const minV = 0;

    const x = (i)=> padL + (W-padL-padR) * (i/4);
    const y = (v)=> padT + (H-padT-padB) * (1 - (v-minV)/(maxV-minV));

    const points = (arr)=> arr.map((v,i)=> `${x(i)},${y(v)}`).join(' ');

    // star marker path (simple 8-ray)
    function starPath(cx, cy, r1, r2){
      const rays = 8;
      let d = '';
      for(let k=0;k<rays*2;k++){
        const ang = (Math.PI * k)/rays;
        const r = (k%2===0)?r2:r1;
        const px = cx + Math.cos(ang)*r;
        const py = cy + Math.sin(ang)*r;
        d += (k===0?`M ${px} ${py}`:` L ${px} ${py}`);
      }
      return d + ' Z';
    }

    const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    svg.setAttribute('width','100%');
    svg.setAttribute('height','auto');

    // background subtle stars
    const bg = document.createElementNS(svg.namespaceURI,'rect');
    bg.setAttribute('x','0'); bg.setAttribute('y','0'); bg.setAttribute('width',W); bg.setAttribute('height',H);
    bg.setAttribute('fill','#0b1020');
    svg.appendChild(bg);

    for(let i=0;i<55;i++){
      const c = document.createElementNS(svg.namespaceURI,'circle');
      c.setAttribute('cx', Math.random()*W);
      c.setAttribute('cy', Math.random()*H);
      c.setAttribute('r', (Math.random()*1.4)+0.3);
      c.setAttribute('fill', 'rgba(255,255,255,'+(Math.random()*0.35+0.05)+')');
      svg.appendChild(c);
    }

    // axis baseline
    const baseLine = document.createElementNS(svg.namespaceURI,'line');
    baseLine.setAttribute('x1', padL);
    baseLine.setAttribute('x2', W-padR);
    baseLine.setAttribute('y1', H-padB);
    baseLine.setAttribute('y2', H-padB);
    baseLine.setAttribute('stroke', 'rgba(255,255,255,.22)');
    baseLine.setAttribute('stroke-width','2');
    svg.appendChild(baseLine);

    // Year labels
    for(let i=0;i<5;i++){
      const t = document.createElementNS(svg.namespaceURI,'text');
      t.setAttribute('x', x(i));
      t.setAttribute('y', H-18);
      t.setAttribute('text-anchor','middle');
      t.setAttribute('fill','rgba(255,255,255,.75)');
      t.setAttribute('font-size','14');
      t.setAttribute('font-weight','800');
      t.textContent = `Year ${i+1}`;
      svg.appendChild(t);
    }

    // Lines
    const line1 = document.createElementNS(svg.namespaceURI,'polyline');
    line1.setAttribute('points', points(annual));
    line1.setAttribute('fill','none');
    line1.setAttribute('stroke','var(--cyan)');
    line1.setAttribute('stroke-width','4');
    line1.setAttribute('stroke-linecap','round');
    line1.setAttribute('stroke-linejoin','round');
    svg.appendChild(line1);

    const line2 = document.createElementNS(svg.namespaceURI,'polyline');
    line2.setAttribute('points', points(high));
    line2.setAttribute('fill','none');
    line2.setAttribute('stroke','var(--gold)');
    line2.setAttribute('stroke-width','4');
    line2.setAttribute('stroke-linecap','round');
    line2.setAttribute('stroke-linejoin','round');
    svg.appendChild(line2);

    // Stars + labels
    function addSeries(arr, color, labelAbove){
      arr.forEach((v,i)=>{
        const cx=x(i), cy=y(v);
        const star = document.createElementNS(svg.namespaceURI,'path');
        star.setAttribute('d', starPath(cx, cy, 6, 12));
        star.setAttribute('fill', 'rgba(255,255,255,.92)');
        star.setAttribute('stroke', color);
        star.setAttribute('stroke-width','2.5');
        svg.appendChild(star);

        const txt = document.createElementNS(svg.namespaceURI,'text');
        txt.setAttribute('x', cx);
        txt.setAttribute('y', cy + (labelAbove?-18:28));
        txt.setAttribute('text-anchor','middle');
        txt.setAttribute('fill', color);
        txt.setAttribute('font-size','16');
        txt.setAttribute('font-weight','900');
        txt.textContent = `₹${v}L`;
        svg.appendChild(txt);
      });
    }
    addSeries(annual, 'var(--cyan)', false);
    addSeries(high, 'var(--gold)', true);

    card.querySelector('#svgWrap').appendChild(svg);
    // --- Export helpers (SVG -> PNG -> PDF) ---
    function serializeSvg(s){
      const clone = s.cloneNode(true);
      // Ensure embedded CSS vars resolve by inlining colors we used
      // (we used stroke='var(--cyan)' etc. in earlier versions; now set to actual colors if present)
      clone.querySelectorAll('[stroke="var(--cyan)"]').forEach(el=>el.setAttribute('stroke', '#22c7f4'));
      clone.querySelectorAll('[stroke="var(--gold)"]').forEach(el=>el.setAttribute('stroke', '#f6b21a'));
      // Add title/subtitle into SVG for export
      const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
      t1.setAttribute('x', W/2); t1.setAttribute('y', 34);
      t1.setAttribute('text-anchor','middle');
      t1.setAttribute('fill','rgba(255,255,255,.95)');
      t1.setAttribute('font-size','22');
      t1.setAttribute('font-weight','900');
      t1.textContent = 'Income Astrologer';
      clone.appendChild(t1);

      const safeName = (advisorName||'').trim();
      const subtitle = safeName ? `${safeName} Ji's Income Potential` : ``;
      const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
      t2.setAttribute('x', W/2); t2.setAttribute('y', 60);
      t2.setAttribute('text-anchor','middle');
      t2.setAttribute('fill','rgba(255,255,255,.85)');
      t2.setAttribute('font-size','16');
      t2.setAttribute('font-weight','800');
      t2.textContent = subtitle;
      clone.appendChild(t2);

      const xml = new XMLSerializer().serializeToString(clone);
      return `<?xml version="1.0" encoding="UTF-8"?>\n` + xml;
    }

    async function svgToPngDataUrl(scale=3){
      const xml = serializeSvg(svg);
      const blob = new Blob([xml], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      try{
        const img = new Image();
        img.decoding = 'async';
        img.src = url;
        await img.decode();
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(W * scale);
        canvas.height = Math.round(H * scale);
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#0b1020';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL('image/png');
      } finally {
        URL.revokeObjectURL(url);
      }
    }

    function nextPngFileName(){
      const safeName = (advisorName||'Advisor').trim() || 'Advisor';
      const key = 'ia_png_count_' + safeName.toLowerCase();
      const n = (parseInt(localStorage.getItem(key)||'0',10) || 0) + 1;
      localStorage.setItem(key, String(n));
      const suffix = String(n).padStart(2,'0');
      return `${safeName} Ji ${suffix}.png`;
    }


    async function downloadPng(){
      const area = document.getElementById('exportArea');
      if(!area){ alert('Nothing to export yet.'); return; }
      if(!window.html2canvas){
        alert('Export library failed to load. Please check internet connection once.');
        return;
      }
      // Capture full output (excluding buttons because buttons are outside exportArea)
      const canvas = await html2canvas(area, {backgroundColor: '#0b1020', scale: 3, useCORS: true});
      const blob = await new Promise(res=>canvas.toBlob(res, 'image/png', 1.0));
      if(!blob){ alert('Could not generate image.'); return; }

      const fileName = nextPngFileName();


      // Android WebView: share directly via native bridge
      try{
        if(__hasAndroid() && typeof window.Android.sharePngBase64 === 'function'){
          const b64 = await __blobToBase64(blob);
          window.Android.sharePngBase64(fileName, b64);
          return;
        }
      }catch(e){}
      // Android WebView: save directly via native bridge
      try{
        if(__hasAndroid() && typeof window.Android.savePngBase64 === 'function'){
          const b64 = await __blobToBase64(blob);
          window.Android.savePngBase64(fileName, b64);
          return;
        }
      }catch(e){}

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }


    async function sharePng(){
      const area = document.getElementById('exportArea');
      if(!area){ alert('Nothing to share yet.'); return; }
      if(!window.html2canvas){
        alert('Export library failed to load. Please check internet connection once.');
        return;
      }
      const canvas = await html2canvas(area, {backgroundColor: '#0b1020', scale: 3, useCORS: true});
      const blob = await new Promise(res=>canvas.toBlob(res, 'image/png', 1.0));
      if(!blob){ alert('Could not generate image.'); return; }

      const fileName = nextPngFileName();

      // Web Share (Android Chrome supports it; WhatsApp shows up in share sheet)
      if(navigator.share && navigator.canShare){
        try{
          const file = new File([blob], fileName, {type:'image/png'});
          if(navigator.canShare({files:[file]})){
            await navigator.share({files:[file], title:fileName, text:'Income Astrologer result'});
            return;
          }
        }catch(e){ /* fallthrough */ }
      }

      // Fallback: download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
      alert('Sharing is not supported on this browser. I downloaded the PNG instead.');
    }
    const bd = card.querySelector('#btnDownload');
    const bs = card.querySelector('#btnShare');
    if(bd) bd.onclick = ()=>downloadPng();
    if(bs) bs.onclick = ()=>sharePng();


    // Table (optional, helps validation)
    const tbl = document.createElement('table');
    tbl.className='table';
    tbl.innerHTML = `
      <thead>
        <tr>
          <th></th>
          <th><span class="pill">Y1</span></th>
          <th><span class="pill">Y2</span></th>
          <th><span class="pill">Y3</span></th>
          <th><span class="pill">Y4</span></th>
          <th><span class="pill">Y5</span></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th style="text-align:left;opacity:.95">High Perf.</th>
          ${high.map(v=>`<td>₹${v}L</td>`).join('')}
        </tr>
        <tr>
          <th style="text-align:left;opacity:.95">Annual</th>
          ${annual.map(v=>`<td>₹${v}L</td>`).join('')}
        </tr>
        </tbody>
    `;
    card.appendChild(tbl);
    window.scrollTo(0, document.body.scrollHeight);
  }

  // --- Flow ---
  bubble("<b>Let’s Analyze Your Income Potential!!</b><br><span class='muted'>Answer 2 quick questions to see your 5-year earning trajectory.</span>");
  const start = document.createElement('div');
  start.className='row';
  start.innerHTML = '<button class="btn" id="go">Yes Let’s Begin!!</button>';
  app.appendChild(start);

  // Ensure the opening message is visible on mobile
  window.scrollTo(0,0);

  
  document.getElementById('go').onclick = ()=>{
    inputQ("1) Name of the Advisor?", "e.g., Ramesh", "text", name=>{
      const advisorName = String(name||'').trim();
      inputQ("2) Starting Leads in the 1st Year?", "e.g., 100", "number", leads=>{
        inputQ("3) Meeting Rate (%) — out of 100 leads, how many will you meet?", "e.g., 70", "number", mr=>{
          bubble("<span class='muted'>Calculating your 5-year forecast…</span>");
          const {annual, high} = estimate(leads, mr);
          renderChart(annual, high, advisorName);
        });
      });
    });
  };

})();
</script>
</body>
</html>
